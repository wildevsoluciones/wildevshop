{% extends "base.html" %}
{% block title %}Carrito | WilDev Shop{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-3">
  <h3 class="m-0">Carrito</h3>
  <a class="btn btn-outline-light btn-sm" href="{{ url_for('home') }}">Seguir comprando</a>
</div>

<div class="row g-3">
  <div class="col-12 col-lg-8">
    <div class="card card-wildev p-3">
      {% if not items %}
        <div class="text-secondary">Tu carrito está vacío. Eso sí que es minimalismo.</div>
      {% else %}

        <!-- Form SOLO para actualizar cantidades -->
        <form action="{{ url_for('cart_update') }}" method="post">
          <div class="table-responsive">
            <table class="table table-dark table-striped align-middle m-0">
              <thead>
                <tr>
                  <th>Producto</th>
                  <th class="text-end">Precio</th>
                  <th style="width:160px" class="text-center">Cantidad</th>
                  <th class="text-end">Subtotal</th>
                  <th class="text-end">Acción</th>
                </tr>
              </thead>

              <tbody>
                {% for it in items %}
                  <tr>
                    <td>
                      <div class="d-flex align-items-center gap-2">
                        <img src="{{ it.product.image_url }}" width="56" height="40"
                             style="object-fit:cover;border-radius:10px;">
                        <div>
                          <div class="fw-semibold">{{ it.product.name }}</div>
                          <div class="small text-secondary">{{ it.product.category }}</div>
                        </div>
                      </div>
                    </td>

                    <td class="text-end">{{ money_ars(it.product.price) }}</td>

                    <td class="text-center">
                      <input class="form-control input-wildev text-center"
                             type="number" min="0" max="50"
                             name="qty_{{ it.product.id }}" value="{{ it.qty }}">
                    </td>

                    <td class="text-end">{{ money_ars(it.subtotal) }}</td>

                    <td class="text-end">
                      <!-- NO anidar forms: usar button con formaction -->
                      <button
                        class="btn btn-sm btn-outline-danger"
                        type="submit"
                        formaction="{{ url_for('cart_remove', product_id=it.product.id) }}"
                        formmethod="post">
                        Quitar
                      </button>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <div class="d-flex justify-content-end mt-3">
            <button class="btn btn-outline-light" type="submit">Actualizar</button>
          </div>
        </form>

      {% endif %}
    </div>
  </div>

  <div class="col-12 col-lg-4">
    <div class="card card-wildev p-3">
      <h5 class="m-0">Resumen</h5>
      <hr class="border-secondary opacity-25">

      <div class="d-flex justify-content-between text-secondary">
        <div>Total</div>
        <div class="text-light fw-semibold">{{ money_ars(total) }}</div>
      </div>

      <div class="small text-secondary mt-2">
        Mercado Pago: te redirige a pagar (real).
      </div>

      <!-- Mercado Pago REAL -->
      <form action="{{ url_for('checkout_mp') }}" method="post" class="mt-3">
        <button class="btn btn-wildev w-100" type="submit" {% if not items %}disabled{% endif %}>
          Pagar con Mercado Pago
        </button>
      </form>

      <!-- Opcional: dejar el checkout demo -->
      <a class="btn btn-outline-light w-100 mt-2 {% if not items %}disabled{% endif %}"
         href="{{ url_for('checkout') }}">
        Checkout demo
      </a>
    </div>
  </div>
</div>
{% endblock %}
