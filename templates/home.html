{% extends "base.html" %}
{% block title %}Tienda | WilDev Shop{% endblock %}
{% from "_macros.html" import badge %}

{% block content %}
<div class="d-flex flex-column flex-lg-row align-items-start gap-3">

  <!-- SIDEBAR CATEGORÍAS -->
  <aside class="card card-wildev sidebar-wildev p-3">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <h5 class="m-0">Categorías</h5>
      <a class="cat-clear" href="{{ url_for('home', q=q) }}">Limpiar</a>
    </div>

    <div class="list-group list-group-flush">
      <a class="list-group-item list-group-item-action list-wildev {% if not cat %}active{% endif %}"
         href="{{ url_for('home', q=q) }}">Todas</a>
      {% for c in categories %}
        <a class="list-group-item list-group-item-action list-wildev {% if cat==c %}active{% endif %}"
           href="{{ url_for('home', cat=c, q=q) }}">{{ c }}</a>
      {% endfor %}
    </div>
  </aside>

  <!-- CONTENIDO PRINCIPAL -->
  <section class="flex-grow-1">

    <!-- HERO -->
    <div class="hero-wildev p-4 p-md-5 mb-3">
      <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between gap-3">
        <div>
          <h2 class="fw-bold m-0">Ecommerce demo, pero con actitud</h2>
          <p class="text-secondary m-0 mt-2">
            Catálogo, carrito, checkout y panel admin (CRUD productos/usuarios).
          </p>
        </div>
        <div class="d-flex gap-2">
          <a class="btn btn-outline-light" href="{{ url_for('cart_view') }}">Ver carrito</a>
          {% if current_user.is_authenticated and current_user.is_admin %}
            <a class="btn btn-wildev" href="{{ url_for('admin_dashboard') }}">Ir a Admin</a>
          {% else %}
            <a class="btn btn-wildev" href="{{ url_for('login') }}">Login</a>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- INFO BÚSQUEDA -->
    <div class="d-flex align-items-center justify-content-between mb-2">
      <div class="text-secondary">
        {% if q %}Buscando: <span class="text-light">{{ q }}</span> · {% endif %}
        {% if cat %}Categoría: <span class="text-light">{{ cat }}</span> · {% endif %}
        Resultados: <span class="text-light">{{ products|length }}</span>
      </div>
    </div>

    <!-- GRID PRODUCTOS -->
    <div class="row g-2 g-md-3">
      {% for p in products %}
      <div class="col-6 col-sm-6 col-lg-4 col-xxl-3">
        <div class="card card-wildev h-100 overflow-hidden">

          <a href="{{ url_for('product_detail', product_id=p.id) }}" class="text-decoration-none">
            <div class="img-wrap">
              <img src="{{ p.image_url }}" alt="{{ p.name }}">
            </div>
          </a>

          <div class="card-body d-flex flex-column p-2 p-md-3">

            <div class="d-flex justify-content-between align-items-start gap-2">
              <h6 class="card-title m-0 line-clamp">{{ p.name }}</h6>
              {{ badge(p.category, "dark") }}
            </div>

            <div class="mt-1 d-flex align-items-center justify-content-between">
              <div class="price">{{ money_ars(p.price) }}</div>
              <div class="small text-secondary">Stock: {{ p.stock }}</div>
            </div>

            <p class="small text-secondary mt-1 line-clamp">
              {{ p.description }}
            </p>

            <div class="mt-auto d-flex gap-2">
              <a class="btn btn-sm btn-outline-light flex-grow-1"
                 href="{{ url_for('product_detail', product_id=p.id) }}">
                Ver
              </a>

              <form action="{{ url_for('cart_add', product_id=p.id) }}" method="post">
                <input type="hidden" name="qty" value="1">
                <button class="btn btn-sm btn-wildev" type="submit">
                  Agregar
                </button>
              </form>
            </div>

          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- SIN RESULTADOS -->
    {% if not products %}
      <div class="card card-wildev p-4 mt-3">
        <div class="text-secondary">
          No hay resultados. Probá otra búsqueda o categoría.
        </div>
      </div>
    {% endif %}

  </section>
</div>
{% endblock %}

